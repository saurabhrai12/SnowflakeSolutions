name: üóÑÔ∏è Snowflake Branch-Based Deployment Pipeline
# 
# Branch-based deployment strategy:
# - feature/*, feat/*, dev/* branches ‚Üí DEV environment
# - main branch ‚Üí STAGING environment  
# - Manual workflow_dispatch ‚Üí Any environment (DEV/STAGING/PROD)
# - Pull requests ‚Üí DEV environment (dry run)

on:
  # Manual trigger with environment selection
  workflow_dispatch:
    inputs:
      target_environment:
        description: 'Target Environment'
        required: true
        default: 'DEV'
        type: choice
        options:
          - DEV
          - STAGING
          - PROD
      deployment_mode:
        description: 'Deployment Mode'
        required: true
        default: 'INCREMENTAL'
        type: choice
        options:
          - INCREMENTAL
          - FULL
          - SCHEMA_SPECIFIC
      target_schemas:
        description: 'Target Schemas (comma-separated, leave empty for all)'
        required: false
        default: ''
        type: string
      dry_run:
        description: 'Dry Run (no actual deployment)'
        required: true
        default: true
        type: boolean
      load_sample_data:
        description: 'Load Sample Data (02_sample_data.sql)'
        required: false
        default: false
        type: boolean
      
  # Automatic triggers: feature branches ‚Üí DEV, main ‚Üí STAGING
  push:
    branches: [ main, 'feature/**', 'feat/**', 'dev/**' ]
    paths: [ 'Account/snowflake/**', 'Customer/snowflake/**', 'shared/snowflake/**' ]
    
  # Pull requests always deploy to DEV (dry run)
  pull_request:
    branches: [ main ]
    paths: [ 'Account/snowflake/**', 'Customer/snowflake/**', 'shared/snowflake/**' ]

env:
  # Build information
  BUILD_NUMBER: ${{ github.run_number }}
  GIT_COMMIT_SHORT: ${{ github.sha }}
  DEPLOYMENT_TIMESTAMP: ${{ github.run_id }}

jobs:
  # Job 1: Determine deployment parameters
  setup:
    name: üèóÔ∏è Setup Deployment
    runs-on: ubuntu-latest
    outputs:
      target_environment: ${{ steps.setup.outputs.target_environment }}
      deployment_mode: ${{ steps.setup.outputs.deployment_mode }}
      target_schemas: ${{ steps.setup.outputs.target_schemas }}
      dry_run: ${{ steps.setup.outputs.dry_run }}
      load_sample_data: ${{ steps.setup.outputs.load_sample_data }}
      snowflake_database: ${{ steps.setup.outputs.snowflake_database }}
      snowflake_warehouse: ${{ steps.setup.outputs.snowflake_warehouse }}
      
    steps:
      - name: üìã Setup Deployment Parameters
        id: setup
        run: |
          # Determine target environment
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TARGET_ENV="${{ github.event.inputs.target_environment }}"
            DEPLOYMENT_MODE="${{ github.event.inputs.deployment_mode }}"
            TARGET_SCHEMAS="${{ github.event.inputs.target_schemas }}"
            DRY_RUN="${{ github.event.inputs.dry_run }}"
            LOAD_SAMPLE_DATA="${{ github.event.inputs.load_sample_data }}"
          elif [ "${{ github.event_name }}" = "push" ]; then
            # Branch-based environment selection
            BRANCH_NAME="${{ github.ref_name }}"
            if [ "$BRANCH_NAME" = "main" ]; then
              TARGET_ENV="STAGING"
              echo "üéØ Main branch detected - deploying to STAGING"
            elif [[ "$BRANCH_NAME" == feature/* ]] || [[ "$BRANCH_NAME" == feat/* ]] || [[ "$BRANCH_NAME" == dev/* ]]; then
              TARGET_ENV="DEV"
              echo "üéØ Feature branch ($BRANCH_NAME) detected - deploying to DEV"
            else
              TARGET_ENV="DEV"
              echo "üéØ Unknown branch ($BRANCH_NAME) - defaulting to DEV"
            fi
            DEPLOYMENT_MODE="INCREMENTAL"
            TARGET_SCHEMAS=""
            DRY_RUN="false"
            LOAD_SAMPLE_DATA="false"
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            TARGET_ENV="DEV"
            DEPLOYMENT_MODE="INCREMENTAL"
            TARGET_SCHEMAS=""
            DRY_RUN="true"
            LOAD_SAMPLE_DATA="false"
          fi
          
          # Set environment-specific database and warehouse
          case $TARGET_ENV in
            "DEV")
              SNOWFLAKE_DATABASE="analytics_platform_dev"
              SNOWFLAKE_WAREHOUSE="analytics_wh_dev"
              ;;
            "STAGING")
              SNOWFLAKE_DATABASE="analytics_platform_staging"
              SNOWFLAKE_WAREHOUSE="analytics_wh_staging"
              ;;
            "PROD")
              SNOWFLAKE_DATABASE="analytics_platform"
              SNOWFLAKE_WAREHOUSE="analytics_wh"
              ;;
          esac
          
          # Output parameters
          echo "target_environment=$TARGET_ENV" >> $GITHUB_OUTPUT
          echo "deployment_mode=$DEPLOYMENT_MODE" >> $GITHUB_OUTPUT
          echo "target_schemas=$TARGET_SCHEMAS" >> $GITHUB_OUTPUT
          echo "dry_run=$DRY_RUN" >> $GITHUB_OUTPUT
          echo "load_sample_data=$LOAD_SAMPLE_DATA" >> $GITHUB_OUTPUT
          echo "snowflake_database=$SNOWFLAKE_DATABASE" >> $GITHUB_OUTPUT
          echo "snowflake_warehouse=$SNOWFLAKE_WAREHOUSE" >> $GITHUB_OUTPUT
          
          # Display deployment plan
          echo "## üóÑÔ∏è Deployment Plan" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | $TARGET_ENV |" >> $GITHUB_STEP_SUMMARY
          echo "| Database | $SNOWFLAKE_DATABASE |" >> $GITHUB_STEP_SUMMARY
          echo "| Warehouse | $SNOWFLAKE_WAREHOUSE |" >> $GITHUB_STEP_SUMMARY
          echo "| Mode | $DEPLOYMENT_MODE |" >> $GITHUB_STEP_SUMMARY
          echo "| Schemas | $TARGET_SCHEMAS |" >> $GITHUB_STEP_SUMMARY
          echo "| Dry Run | $DRY_RUN |" >> $GITHUB_STEP_SUMMARY
          echo "| Load Sample Data | $LOAD_SAMPLE_DATA |" >> $GITHUB_STEP_SUMMARY

  # Job 2: SQL Validation
  validate:
    name: üîç SQL Validation
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4
        
      - name: üîç Validate SQL Schemas
        run: |
          echo "üîç Validating SQL files for ${{ needs.setup.outputs.target_environment }}..."
          
          # Create validation report
          mkdir -p reports
          echo "# SQL Validation Report" > reports/sql-validation.md
          echo "Environment: ${{ needs.setup.outputs.target_environment }}" >> reports/sql-validation.md
          echo "" >> reports/sql-validation.md
          
          # Check for dangerous patterns in new structure
          DANGEROUS_PATTERNS=0
          if find Account/snowflake/ Customer/snowflake/ shared/snowflake/ -name "*.sql" -exec grep -l "DROP TABLE\|DROP DATABASE\|TRUNCATE" {} \; 2>/dev/null | wc -l | grep -v '^0$'; then
            echo "‚ö†Ô∏è Found dangerous DROP/TRUNCATE statements" >> reports/sql-validation.md
            DANGEROUS_PATTERNS=1
          fi
          
          # Check for idempotent patterns
          NON_IDEMPOTENT=0
          if find Account/snowflake/ Customer/snowflake/ shared/snowflake/ -name "*.sql" -exec grep -L "CREATE OR REPLACE\|CREATE.*IF NOT EXISTS" {} \; 2>/dev/null | wc -l | grep -v '^0$'; then
            echo "‚ö†Ô∏è Found non-idempotent CREATE statements" >> reports/sql-validation.md
            NON_IDEMPOTENT=1
          fi
          
          # Summary
          if [ $DANGEROUS_PATTERNS -eq 0 ] && [ $NON_IDEMPOTENT -eq 0 ]; then
            echo "‚úÖ All SQL files passed validation" >> reports/sql-validation.md
            echo "‚úÖ SQL validation passed"
          else
            echo "‚ö†Ô∏è SQL validation completed with warnings" >> reports/sql-validation.md
            echo "‚ö†Ô∏è SQL validation has warnings (non-blocking)"
          fi
          
      - name: üìä Upload Validation Report
        uses: actions/upload-artifact@v4
        with:
          name: sql-validation-report
          path: reports/

  # Job 3: Deployment approval for STAGING/PROD
  approval:
    name: üîí Deployment Approval
    runs-on: ubuntu-latest
    needs: [setup, validate]
    if: contains(fromJSON('["STAGING", "PROD"]'), needs.setup.outputs.target_environment) && needs.setup.outputs.dry_run == 'false'
    environment: 
      name: ${{ needs.setup.outputs.target_environment }}
      
    steps:
      - name: üìã Approval Required
        run: |
          echo "üîí Manual approval required for ${{ needs.setup.outputs.target_environment }} deployment"
          echo "Database: ${{ needs.setup.outputs.snowflake_database }}"
          echo "Warehouse: ${{ needs.setup.outputs.snowflake_warehouse }}"
          echo "Mode: ${{ needs.setup.outputs.deployment_mode }}"

  # Job 4: SQL Schema Deployment
  deploy:
    name: üóÑÔ∏è Deploy to ${{ needs.setup.outputs.target_environment }}
    runs-on: ubuntu-latest
    needs: [setup, validate, approval]
    if: always() && needs.validate.result == 'success' && (needs.approval.result == 'success' || needs.approval.result == 'skipped')
    
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for git diff
        
      - name: üîß Install Snowflake CLI
        uses: snowflakedb/snowflake-cli-action@v1.5
        with:
          cli-version: "latest"
          default-config-file-path: "snowflake-config.toml"
          
      - name: üìù Create Snowflake Configuration
        run: |
          echo "üìù Creating Snowflake CLI configuration..."
          mkdir -p ~/.snowflake
          cat > ~/.snowflake/config.toml << EOF
          [connections.default]
          account = "${{ secrets[format('SNOWFLAKE_{0}_ACCOUNT', needs.setup.outputs.target_environment)] }}"
          user = "${{ secrets[format('SNOWFLAKE_{0}_USER', needs.setup.outputs.target_environment)] }}"
          password = "${{ secrets[format('SNOWFLAKE_{0}_PASSWORD', needs.setup.outputs.target_environment)] }}"
          warehouse = "${{ needs.setup.outputs.snowflake_warehouse }}"
          database = "${{ needs.setup.outputs.snowflake_database }}"
          EOF
          
      - name: üîå Test Snowflake Connection
        run: |
          echo "üîå Testing Snowflake connection with CLI..."
          snow connection test --connection-name default
          echo "‚úÖ Snowflake CLI connection successful"
          
      - name: üîç Detect Changed Files
        id: changes
        run: |
          echo "üîç Detecting changed SQL files..."
          
          # Determine base reference for git diff
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_REF="origin/${{ github.base_ref }}"
          else
            BASE_REF="HEAD~1"
          fi
          
          echo "base_ref=$BASE_REF" >> $GITHUB_OUTPUT
          
          # Get changed SQL files
          CHANGED_FILES=$(git diff --name-only $BASE_REF HEAD -- Account/snowflake/ Customer/snowflake/ shared/snowflake/ | grep '\.sql$' || true)
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "üìù Changed SQL files:"
          echo "$CHANGED_FILES" | while read -r file; do
            [ -n "$file" ] && echo "  - $file"
          done
          
      - name: üóÑÔ∏è Deploy SQL Schemas with Snowflake CLI
        if: needs.setup.outputs.dry_run == 'false'
        run: |
          echo "üöÄ Deploying to ${{ needs.setup.outputs.target_environment }} using Snowflake CLI..."
          mkdir -p deployment-logs
          
          # Set database and warehouse context
          snow sql -q "USE DATABASE ${{ needs.setup.outputs.snowflake_database }}" --connection default
          snow sql -q "USE WAREHOUSE ${{ needs.setup.outputs.snowflake_warehouse }}" --connection default
          
          # Deploy foundation files first
          echo "üèóÔ∏è Deploying foundation schema..."
          if [ -f "Account/snowflake/schemas/00_database_and_warehouse.sql" ]; then
            echo "  Executing: Account/snowflake/schemas/00_database_and_warehouse.sql"
            snow sql -f Account/snowflake/schemas/00_database_and_warehouse.sql --connection default
          fi
          
          # Deployment logic based on changed files and deployment mode
          DEPLOYMENT_MODE="${{ needs.setup.outputs.deployment_mode }}"
          TARGET_SCHEMAS="${{ needs.setup.outputs.target_schemas }}"
          CHANGED_FILES="${{ steps.changes.outputs.changed_files }}"
          
          echo "üìã Deployment Mode: $DEPLOYMENT_MODE"
          echo "üìã Target Schemas: $TARGET_SCHEMAS"
          echo "üìã Changed Files: $CHANGED_FILES"
          
          # Create deployment tracking table
          echo "üìä Creating deployment tracking..."
          snow sql -q "CREATE OR REPLACE TABLE monitoring.github_deployments (
            run_id VARCHAR(50),
            deployment_time TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP(),
            environment VARCHAR(50),
            git_sha VARCHAR(50),
            deployment_mode VARCHAR(50),
            actor VARCHAR(100),
            files_deployed NUMBER,
            status VARCHAR(20)
          )" --connection default
          
          # Define schema deployment order
          SCHEMAS_ORDER=("monitoring" "raw_data" "processed_data" "reporting")
          
          # Deploy schemas based on mode
          FILES_DEPLOYED=0
          
          if [ "$DEPLOYMENT_MODE" = "FULL" ] || [ -z "$TARGET_SCHEMAS" ]; then
            echo "üíØ Full deployment - deploying all schemas"
            
            # Deploy monitoring schema
            for file in Customer/snowflake/monitoring/*.sql; do
              if [ -f "$file" ]; then
                echo "  üìä Executing: $file"
                snow sql -f "$file" --connection default
                FILES_DEPLOYED=$((FILES_DEPLOYED + 1))
              fi
            done
            
            # Deploy raw_data schema
            for file in Account/snowflake/schemas/raw_data/*.sql; do
              if [ -f "$file" ]; then
                echo "  üìä Executing: $file"
                snow sql -f "$file" --connection default
                FILES_DEPLOYED=$((FILES_DEPLOYED + 1))
              fi
            done
            
            # Deploy processed_data schema
            for file in Account/snowflake/schemas/processed_data/*.sql; do
              if [ -f "$file" ]; then
                echo "  üìä Executing: $file"
                snow sql -f "$file" --connection default
                FILES_DEPLOYED=$((FILES_DEPLOYED + 1))
              fi
            done
            
            # Deploy reporting schema
            for file in shared/snowflake/reporting/*.sql; do
              if [ -f "$file" ]; then
                echo "  üìä Executing: $file"
                snow sql -f "$file" --connection default
                FILES_DEPLOYED=$((FILES_DEPLOYED + 1))
              fi
            done
            
          elif [ "$DEPLOYMENT_MODE" = "INCREMENTAL" ]; then
            echo "üîÑ Incremental deployment - processing changed files"
            
            # Process each changed file
            echo "$CHANGED_FILES" | while IFS= read -r file; do
              if [ -n "$file" ] && [ -f "$file" ]; then
                echo "  üìä Executing changed file: $file"
                snow sql -f "$file" --connection default
                FILES_DEPLOYED=$((FILES_DEPLOYED + 1))
              fi
            done
            
          else
            echo "üéØ Schema-specific deployment"
            
            # Deploy specific schemas
            IFS=',' read -ra SCHEMA_ARRAY <<< "$TARGET_SCHEMAS"
            for schema in "${SCHEMA_ARRAY[@]}"; do
              schema=$(echo "$schema" | xargs)  # trim whitespace
              echo "  üìä Deploying schema: $schema"
              
              case "$schema" in
                "monitoring")
                  for file in Customer/snowflake/monitoring/*.sql; do
                    if [ -f "$file" ]; then
                      echo "    üìä Executing: $file"
                      snow sql -f "$file" --connection default
                      FILES_DEPLOYED=$((FILES_DEPLOYED + 1))
                    fi
                  done
                  ;;
                "raw_data")
                  for file in Account/snowflake/schemas/raw_data/*.sql; do
                    if [ -f "$file" ]; then
                      echo "    üìä Executing: $file"
                      snow sql -f "$file" --connection default
                      FILES_DEPLOYED=$((FILES_DEPLOYED + 1))
                    fi
                  done
                  ;;
                "processed_data")
                  for file in Account/snowflake/schemas/processed_data/*.sql; do
                    if [ -f "$file" ]; then
                      echo "    üìä Executing: $file"
                      snow sql -f "$file" --connection default
                      FILES_DEPLOYED=$((FILES_DEPLOYED + 1))
                    fi
                  done
                  ;;
                "reporting")
                  for file in shared/snowflake/reporting/*.sql; do
                    if [ -f "$file" ]; then
                      echo "    üìä Executing: $file"
                      snow sql -f "$file" --connection default
                      FILES_DEPLOYED=$((FILES_DEPLOYED + 1))
                    fi
                  done
                  ;;
              esac
            done
          fi
          
          # Deploy permissions (always last)
          if [ -f "Account/snowflake/schemas/permissions.sql" ]; then
            echo "üîê Deploying permissions..."
            snow sql -f Account/snowflake/schemas/permissions.sql --connection default
            FILES_DEPLOYED=$((FILES_DEPLOYED + 1))
          fi
          
          # Record deployment
          snow sql -q "INSERT INTO monitoring.github_deployments VALUES (
            '${{ github.run_id }}',
            CURRENT_TIMESTAMP(),
            '${{ needs.setup.outputs.target_environment }}',
            '${{ github.sha }}',
            '$DEPLOYMENT_MODE',
            '${{ github.actor }}',
            $FILES_DEPLOYED,
            'SUCCESS'
          )" --connection default
          
          echo "üéâ Deployment completed successfully! Files deployed: $FILES_DEPLOYED"
          echo "Files deployed: $FILES_DEPLOYED" > deployment-logs/deployment.log
          
      - name: üîç Dry Run Report
        if: needs.setup.outputs.dry_run == 'true'
        run: |
          echo "üîç DRY RUN - No actual deployment performed"
          echo ""
          echo "## üóÑÔ∏è Deployment Plan" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ needs.setup.outputs.target_environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Database:** ${{ needs.setup.outputs.snowflake_database }}" >> $GITHUB_STEP_SUMMARY
          echo "**Warehouse:** ${{ needs.setup.outputs.snowflake_warehouse }}" >> $GITHUB_STEP_SUMMARY
          echo "**Mode:** ${{ needs.setup.outputs.deployment_mode }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Would deploy SQL files:" >> $GITHUB_STEP_SUMMARY
          echo "- Database: \`${{ needs.setup.outputs.snowflake_database }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Warehouse: \`${{ needs.setup.outputs.snowflake_warehouse }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Foundation: 00_database_and_warehouse.sql" >> $GITHUB_STEP_SUMMARY
          echo "- Monitoring: tables.sql, stored_procedures.sql" >> $GITHUB_STEP_SUMMARY
          echo "- Raw Data: tables.sql, procedures, streams, tasks" >> $GITHUB_STEP_SUMMARY
          echo "- Processed Data: tables.sql, procedures" >> $GITHUB_STEP_SUMMARY
          echo "- Reporting: views.sql" >> $GITHUB_STEP_SUMMARY
          echo "- Permissions: permissions.sql" >> $GITHUB_STEP_SUMMARY
          echo "- Total: 18 SQL files with tables, views, procedures, and tasks" >> $GITHUB_STEP_SUMMARY
          
      - name: üîç Post-Deployment Verification
        if: needs.setup.outputs.dry_run == 'false'
        run: |
          echo "üîç Verifying deployment..."
          
          # Verify connection and context
          echo "üìã Checking database and warehouse..."
          snow sql -q "SELECT CURRENT_DATABASE(), CURRENT_WAREHOUSE()" --connection default
          
          # Check schemas
          echo "üóÑÔ∏è Verifying schemas exist..."
          snow sql -q "SHOW SCHEMAS" --connection default
          # Check objects in each schema
          echo "üìä Verifying deployed objects..."
          
          # Check monitoring schema objects
          echo "  üîç Checking monitoring schema..."
          snow sql -q "SHOW TABLES IN SCHEMA monitoring" --connection default || echo "  ‚ö†Ô∏è monitoring schema not found or empty"
          
          # Check raw_data schema objects  
          echo "  üîç Checking raw_data schema..."
          snow sql -q "SHOW TABLES IN SCHEMA raw_data" --connection default || echo "  ‚ö†Ô∏è raw_data schema not found or empty"
          
          # Check processed_data schema objects
          echo "  üîç Checking processed_data schema..."
          snow sql -q "SHOW TABLES IN SCHEMA processed_data" --connection default || echo "  ‚ö†Ô∏è processed_data schema not found or empty"
          
          # Check reporting schema objects
          echo "  üîç Checking reporting schema..."
          snow sql -q "SHOW VIEWS IN SCHEMA reporting" --connection default || echo "  ‚ö†Ô∏è reporting schema not found or empty"
          
          # Check deployment tracking
          echo "üìä Checking deployment tracking..."
          snow sql -q "SELECT COUNT(*) FROM monitoring.github_deployments WHERE run_id = '${{ github.run_id }}'" --connection default || echo "‚ö†Ô∏è Could not check deployment tracking"
          
          echo "‚úÖ Verification completed!"
          
      - name: üìä Upload Deployment Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-logs-${{ needs.setup.outputs.target_environment }}
          path: deployment-logs/
          
      - name: üìà Generate Deployment Summary
        if: needs.setup.outputs.dry_run == 'false'
        run: |
          echo "## üéâ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ needs.setup.outputs.target_environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Database | ${{ needs.setup.outputs.snowflake_database }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Warehouse | ${{ needs.setup.outputs.snowflake_warehouse }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Run ID | ${{ github.run_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Git SHA | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Actor | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ **Deployment completed successfully!**" >> $GITHUB_STEP_SUMMARY

  # Job 5: Load Sample Data (Optional)
  load_sample_data:
    name: üìä Load Sample Data
    runs-on: ubuntu-latest
    needs: [setup, deploy]
    if: always() && needs.setup.outputs.dry_run == 'false' && needs.setup.outputs.load_sample_data == 'true' && needs.deploy.result == 'success'
    
    steps:
      - name: üîç Debug Sample Data Conditions
        run: |
          echo "üîç Checking sample data loading conditions:"
          echo "  - Dry run: '${{ needs.setup.outputs.dry_run }}' (should be 'false')"
          echo "  - Load sample data: '${{ needs.setup.outputs.load_sample_data }}' (should be 'true')" 
          echo "  - Deploy result: '${{ needs.deploy.result }}' (should be 'success')"
          echo "  - Condition result: ${{ needs.setup.outputs.dry_run == 'false' && needs.setup.outputs.load_sample_data == 'true' && needs.deploy.result == 'success' }}"
          
      - name: üì• Checkout Code
        uses: actions/checkout@v4
        
      - name: üîß Install Snowflake CLI
        uses: snowflakedb/snowflake-cli-action@v1.5
        with:
          cli-version: "latest"
          default-config-file-path: "snowflake-config.toml"
          
      - name: üìù Create Snowflake Configuration
        run: |
          echo "üìù Creating Snowflake CLI configuration..."
          mkdir -p ~/.snowflake
          cat > ~/.snowflake/config.toml << EOF
          [connections.default]
          account = "${{ secrets[format('SNOWFLAKE_{0}_ACCOUNT', needs.setup.outputs.target_environment)] }}"
          user = "${{ secrets[format('SNOWFLAKE_{0}_USER', needs.setup.outputs.target_environment)] }}"
          password = "${{ secrets[format('SNOWFLAKE_{0}_PASSWORD', needs.setup.outputs.target_environment)] }}"
          warehouse = "${{ needs.setup.outputs.snowflake_warehouse }}"
          database = "${{ needs.setup.outputs.snowflake_database }}"
          EOF
          
      - name: üìä Load Sample Data with Snowflake CLI
        run: |
          echo "üìä Loading sample data to ${{ needs.setup.outputs.target_environment }} using Snowflake CLI..."
          
          # Load sample data using Snowflake CLI
          if [ -f "Account/snowflake/02_sample_data.sql" ]; then
            echo "üìä Executing sample data file: Account/snowflake/02_sample_data.sql"
            snow sql -f Account/snowflake/02_sample_data.sql --connection default
            echo "üéâ Sample data loaded successfully!"
          else
            echo "‚ö†Ô∏è Sample data file not found: Account/snowflake/02_sample_data.sql"
          fi

  # Job 6: Notification
  notify:
    name: üì¢ Notification
    runs-on: ubuntu-latest
    needs: [setup, deploy, approval, load_sample_data]
    if: always()
    
    steps:
      - name: üì¢ Deployment Notification
        run: |
          echo "üîç Debug Information:"
          echo "  - Deploy result: ${{ needs.deploy.result }}"
          echo "  - Load sample data result: ${{ needs.load_sample_data.result }}"
          echo "  - Dry run setting: ${{ needs.setup.outputs.dry_run }}"
          echo "  - Load sample data setting: ${{ needs.setup.outputs.load_sample_data }}"
          echo ""
          
          if [ "${{ needs.deploy.result }}" = "success" ]; then
            echo "üéâ Deployment to ${{ needs.setup.outputs.target_environment }} completed successfully!"
          elif [ "${{ needs.deploy.result }}" = "failure" ]; then
            echo "‚ùå Deployment to ${{ needs.setup.outputs.target_environment }} failed!"
          elif [ "${{ needs.deploy.result }}" = "skipped" ]; then
            echo "‚è≠Ô∏è Deployment to ${{ needs.setup.outputs.target_environment }} was skipped (dry run or no approval)"
          fi
          
          if [ "${{ needs.load_sample_data.result }}" = "success" ]; then
            echo "üìä Sample data loaded successfully!"
          elif [ "${{ needs.load_sample_data.result }}" = "skipped" ]; then
            echo "‚è≠Ô∏è Sample data loading was skipped"
          elif [ "${{ needs.load_sample_data.result }}" = "failure" ]; then
            echo "‚ùå Sample data loading failed!"
          fi