name: 🗄️ Snowflake Git Integration Deployment

# Simplified deployment using Snowflake Git integration with Jinja templating
# This approach leverages native Snowflake capabilities for environment-specific deployments

on:
  # Manual trigger with environment selection
  workflow_dispatch:
    inputs:
      target_environment:
        description: 'Target Environment'
        required: true
        default: 'DEV'
        type: choice
        options:
          - DEV
          - STAGING
          - PROD
      load_sample_data:
        description: 'Load Sample Data'
        required: false
        default: false
        type: boolean
      dry_run:
        description: 'Dry Run (show what would be deployed)'
        required: true
        default: true
        type: boolean
      
  # Automatic triggers: feature branches → DEV, main → STAGING
  push:
    branches: [ main, 'feature/**', 'feat/**', 'dev/**' ]
    paths: [ 'Account/snowflake/**', 'Customer/snowflake/**', 'shared/snowflake/**' ]

  pull_request:
    branches: [ main ]
    paths: [ 'Account/snowflake/**', 'Customer/snowflake/**', 'shared/snowflake/**' ]

env:
  # Default Snowflake CLI environment variables
  SNOWFLAKE_CONNECTIONS_DEFAULT_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
  SNOWFLAKE_CONNECTIONS_DEFAULT_USER: ${{ secrets.SNOWFLAKE_USER }}
  SNOWFLAKE_CONNECTIONS_DEFAULT_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}

jobs:
  # Job 1: Setup and determine deployment parameters
  setup:
    name: 🔧 Setup Deployment Parameters
    runs-on: ubuntu-latest
    outputs:
      target_environment: ${{ steps.setup.outputs.target_environment }}
      environment_vars: ${{ steps.setup.outputs.environment_vars }}
      dry_run: ${{ steps.setup.outputs.dry_run }}
      load_sample_data: ${{ steps.setup.outputs.load_sample_data }}
      git_repo_name: ${{ steps.setup.outputs.git_repo_name }}
      
    steps:
      - name: 📥 Checkout Code
        uses: actions/checkout@v4
        
      - name: 🔧 Install yq for YAML parsing
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
        
      - name: 🎯 Determine Deployment Parameters
        id: setup
        run: |
          # Determine target environment based on trigger
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TARGET_ENV="${{ github.event.inputs.target_environment }}"
            DRY_RUN="${{ github.event.inputs.dry_run }}"
            LOAD_SAMPLE_DATA="${{ github.event.inputs.load_sample_data }}"
          elif [ "${{ github.event_name }}" = "push" ]; then
            # Branch-based environment selection
            if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
              TARGET_ENV="STAGING"
            else
              TARGET_ENV="DEV"
            fi
            DRY_RUN="false"
            LOAD_SAMPLE_DATA="false"
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            TARGET_ENV="DEV"
            DRY_RUN="true"
            LOAD_SAMPLE_DATA="false"
          fi
          
          # Get environment variables from configuration
          ENVIRONMENT_VARS=$(yq eval ".environments.$TARGET_ENV.variables" .github/deployment-config.yml -o=json)
          
          # Generate Git repository name (for Snowflake Git integration)
          GIT_REPO_NAME="analytics_platform_git_repo"
          
          # Output parameters
          echo "target_environment=$TARGET_ENV" >> $GITHUB_OUTPUT
          echo "environment_vars=$ENVIRONMENT_VARS" >> $GITHUB_OUTPUT
          echo "dry_run=$DRY_RUN" >> $GITHUB_OUTPUT
          echo "load_sample_data=$LOAD_SAMPLE_DATA" >> $GITHUB_OUTPUT
          echo "git_repo_name=$GIT_REPO_NAME" >> $GITHUB_OUTPUT
          
          # Display deployment plan
          echo "## 🗄️ Deployment Plan" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** $TARGET_ENV" >> $GITHUB_STEP_SUMMARY
          echo "**Dry Run:** $DRY_RUN" >> $GITHUB_STEP_SUMMARY
          echo "**Load Sample Data:** $LOAD_SAMPLE_DATA" >> $GITHUB_STEP_SUMMARY
          echo "**Git Repository:** $GIT_REPO_NAME" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Environment Variables:" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          echo "$ENVIRONMENT_VARS" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # Job 2: Validation
  validate:
    name: 🔍 Validate SQL and Configuration
    runs-on: ubuntu-latest
    needs: [setup]
    
    steps:
      - name: 📥 Checkout Code
        uses: actions/checkout@v4
        
      - name: 🔍 Validate Jinja Templates
        run: |
          echo "🔍 Validating Jinja templates in SQL files..."
          
          # Check for basic Jinja syntax issues
          INVALID_FILES=()
          
          # Find all SQL files with Jinja templates
          while IFS= read -r -d '' file; do
            if grep -q "{{.*}}" "$file"; then
              echo "  📋 Template file: $file"
              
              # Check for common Jinja syntax issues
              if grep -q "{{ *[^}]*[^}] *}}" "$file"; then
                echo "    ✅ Basic Jinja syntax looks correct"
              else
                echo "    ❌ Potential Jinja syntax issue"
                INVALID_FILES+=("$file")
              fi
            fi
          done < <(find . -name "*.sql" -print0)
          
          # Report validation results
          if [ ${#INVALID_FILES[@]} -eq 0 ]; then
            echo "✅ All Jinja templates passed validation"
          else
            echo "❌ Found issues in ${#INVALID_FILES[@]} files:"
            for file in "${INVALID_FILES[@]}"; do
              echo "  - $file"
            done
            exit 1
          fi

  # Job 3: Deploy using Snowflake Git Integration
  deploy:
    name: 🚀 Deploy with Snowflake Git Integration
    runs-on: ubuntu-latest
    needs: [setup, validate]
    if: needs.setup.outputs.dry_run == 'false'
    
    steps:
      - name: 📥 Checkout Code
        uses: actions/checkout@v4
        
      - name: 🔧 Install Snowflake CLI
        uses: Snowflake-Labs/snowflake-cli-action@v1.5
        with:
          cli-version: "latest"
          default-config-file-path: ".snowflake/config.toml"
          
      - name: 🔌 Test Snowflake Connection
        run: |
          echo "🔌 Testing Snowflake connection..."
          snow connection test --connection default
          echo "✅ Snowflake CLI connection successful"
          
      - name: 📊 Setup Git Repository in Snowflake
        run: |
          echo "📊 Setting up Git repository in Snowflake..."
          
          # Create or replace Git repository reference
          snow sql -q "CREATE OR REPLACE GIT REPOSITORY ${{ needs.setup.outputs.git_repo_name }}
            API_INTEGRATION = git_api_integration
            GIT_CREDENTIALS = git_secret
            ORIGIN = '${{ github.server_url }}/${{ github.repository }}.git'" --connection default
          
          echo "✅ Git repository configured: ${{ needs.setup.outputs.git_repo_name }}"
          
      - name: 🔄 Fetch Latest Repository Changes
        run: |
          echo "🔄 Fetching latest repository changes..."
          snow git fetch ${{ needs.setup.outputs.git_repo_name }}
          echo "✅ Repository changes fetched successfully"
          
      - name: 🗄️ Deploy Foundation Scripts
        run: |
          echo "🗄️ Deploying foundation scripts with environment variables..."
          
          # Parse environment variables into -D parameters
          ENV_VARS='${{ needs.setup.outputs.environment_vars }}'
          DEFINE_PARAMS=""
          
          # Convert JSON to -D parameters
          for key in $(echo "$ENV_VARS" | jq -r 'keys[]'); do
            value=$(echo "$ENV_VARS" | jq -r ".$key")
            DEFINE_PARAMS="$DEFINE_PARAMS -D \"$key='$value'\""
          done
          
          echo "📋 Using define parameters: $DEFINE_PARAMS"
          
          # Deploy foundation scripts
          eval "snow git execute '@${{ needs.setup.outputs.git_repo_name }}/branches/${{ github.ref_name }}/Account/snowflake/schemas/00_database_and_warehouse.sql' $DEFINE_PARAMS" --connection default
          
          echo "✅ Foundation scripts deployed"
          
      - name: 📊 Deploy Schema Scripts
        run: |
          echo "📊 Deploying schema scripts in dependency order..."
          
          # Parse environment variables into -D parameters
          ENV_VARS='${{ needs.setup.outputs.environment_vars }}'
          DEFINE_PARAMS=""
          
          for key in $(echo "$ENV_VARS" | jq -r 'keys[]'); do
            value=$(echo "$ENV_VARS" | jq -r ".$key")
            DEFINE_PARAMS="$DEFINE_PARAMS -D \"$key='$value'\""
          done
          
          # Deploy in dependency order
          echo "  📊 Deploying monitoring schema..."
          eval "snow git execute '@${{ needs.setup.outputs.git_repo_name }}/branches/${{ github.ref_name }}/Customer/snowflake/monitoring/*' $DEFINE_PARAMS" --connection default
          
          echo "  📊 Deploying raw_data schema..."
          eval "snow git execute '@${{ needs.setup.outputs.git_repo_name }}/branches/${{ github.ref_name }}/Account/snowflake/schemas/raw_data/*' $DEFINE_PARAMS" --connection default
          
          echo "  📊 Deploying processed_data schema..."
          eval "snow git execute '@${{ needs.setup.outputs.git_repo_name }}/branches/${{ github.ref_name }}/Account/snowflake/schemas/processed_data/*' $DEFINE_PARAMS" --connection default
          
          echo "  📊 Deploying reporting schema..."
          eval "snow git execute '@${{ needs.setup.outputs.git_repo_name }}/branches/${{ github.ref_name }}/shared/snowflake/reporting/*' $DEFINE_PARAMS" --connection default
          
          echo "✅ All schema scripts deployed"
          
      - name: 🔐 Deploy Permissions
        run: |
          echo "🔐 Deploying permissions..."
          
          # Parse environment variables into -D parameters
          ENV_VARS='${{ needs.setup.outputs.environment_vars }}'
          DEFINE_PARAMS=""
          
          for key in $(echo "$ENV_VARS" | jq -r 'keys[]'); do
            value=$(echo "$ENV_VARS" | jq -r ".$key")
            DEFINE_PARAMS="$DEFINE_PARAMS -D \"$key='$value'\""
          done
          
          # Deploy permissions
          eval "snow git execute '@${{ needs.setup.outputs.git_repo_name }}/branches/${{ github.ref_name }}/Account/snowflake/schemas/permissions.sql' $DEFINE_PARAMS" --connection default
          
          echo "✅ Permissions deployed"
          
      - name: 📊 Load Sample Data (Optional)
        if: needs.setup.outputs.load_sample_data == 'true'
        run: |
          echo "📊 Loading sample data..."
          
          # Parse environment variables into -D parameters
          ENV_VARS='${{ needs.setup.outputs.environment_vars }}'
          DEFINE_PARAMS=""
          
          for key in $(echo "$ENV_VARS" | jq -r 'keys[]'); do
            value=$(echo "$ENV_VARS" | jq -r ".$key")
            DEFINE_PARAMS="$DEFINE_PARAMS -D \"$key='$value'\""
          done
          
          # Load sample data
          eval "snow git execute '@${{ needs.setup.outputs.git_repo_name }}/branches/${{ github.ref_name }}/Account/snowflake/02_sample_data.sql' $DEFINE_PARAMS" --connection default
          
          echo "✅ Sample data loaded"

  # Job 4: Dry Run Report
  dry_run:
    name: 🔍 Dry Run Report
    runs-on: ubuntu-latest
    needs: [setup, validate]
    if: needs.setup.outputs.dry_run == 'true'
    
    steps:
      - name: 🔍 Generate Dry Run Report
        run: |
          echo "🔍 DRY RUN - No actual deployment performed"
          echo ""
          echo "## 🗄️ Deployment Plan" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ needs.setup.outputs.target_environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Git Repository:** ${{ needs.setup.outputs.git_repo_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Would execute these commands:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# Foundation" >> $GITHUB_STEP_SUMMARY
          echo "snow git execute '@${{ needs.setup.outputs.git_repo_name }}/branches/${{ github.ref_name }}/Account/snowflake/schemas/00_database_and_warehouse.sql' -D \"environment='${{ needs.setup.outputs.target_environment }}'" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Schemas" >> $GITHUB_STEP_SUMMARY
          echo "snow git execute '@${{ needs.setup.outputs.git_repo_name }}/branches/${{ github.ref_name }}/Customer/snowflake/monitoring/*' -D \"environment='${{ needs.setup.outputs.target_environment }}'" >> $GITHUB_STEP_SUMMARY
          echo "snow git execute '@${{ needs.setup.outputs.git_repo_name }}/branches/${{ github.ref_name }}/Account/snowflake/schemas/raw_data/*' -D \"environment='${{ needs.setup.outputs.target_environment }}'" >> $GITHUB_STEP_SUMMARY
          echo "snow git execute '@${{ needs.setup.outputs.git_repo_name }}/branches/${{ github.ref_name }}/Account/snowflake/schemas/processed_data/*' -D \"environment='${{ needs.setup.outputs.target_environment }}'" >> $GITHUB_STEP_SUMMARY
          echo "snow git execute '@${{ needs.setup.outputs.git_repo_name }}/branches/${{ github.ref_name }}/shared/snowflake/reporting/*' -D \"environment='${{ needs.setup.outputs.target_environment }}'" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Permissions" >> $GITHUB_STEP_SUMMARY
          echo "snow git execute '@${{ needs.setup.outputs.git_repo_name }}/branches/${{ github.ref_name }}/Account/snowflake/schemas/permissions.sql' -D \"environment='${{ needs.setup.outputs.target_environment }}'" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Environment Variables:" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          echo '${{ needs.setup.outputs.environment_vars }}' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # Job 5: Notification
  notify:
    name: 📢 Deployment Notification
    runs-on: ubuntu-latest
    needs: [setup, deploy, dry_run]
    if: always()
    
    steps:
      - name: 📢 Send Notification
        run: |
          if [ "${{ needs.deploy.result }}" = "success" ]; then
            echo "🎉 Deployment to ${{ needs.setup.outputs.target_environment }} completed successfully!"
          elif [ "${{ needs.dry_run.result }}" = "success" ]; then
            echo "🔍 Dry run for ${{ needs.setup.outputs.target_environment }} completed successfully!"
          else
            echo "❌ Deployment failed. Check the logs for details."
            exit 1
          fi